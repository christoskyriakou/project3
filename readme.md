# Ανίχνευση Απομακρυσμένων Ομολόγων Πρωτεϊνών με Μεθόδους ANN

**Εργασία 3 - Υπολογιστική Βιολογία & Αναζήτηση Δεδομένων**  
**Χειμερινό Εξάμηνο 2025-26**  
**Developers:** Κυριακού Χρήστος - sdi2300096, Πετρίδου Ελισάβετ - sdi2300170


Σύστημα για την ανίχνευση απομακρυσμένων ομολόγων πρωτεϊνών (remote homologs) χρησιμοποιώντας ESM-2 embeddings και αλγορίθμους Προσεγγιστικής Αναζήτησης Πλησιέστερων Γειτόνων (Approximate Nearest Neighbor - ANN).

---

## Περιγραφή

Τα παραδοσιακά εργαλεία στοίχισης ακολουθιών όπως το BLAST αδυνατούν να ανιχνεύσουν **απομακρυσμένες ομόλογες** (remote homologs) πρωτεΐνες - πρωτεΐνες που διατηρούν παρόμοια τρισδιάστατη δομή και λειτουργία παρόλο που έχουν χαμηλή ομοιότητα αλληλουχίας (<30%, γνωστή ως "Ζώνη Λυκόφωτος" - Twilight Zone).

Αυτό το έργο υλοποιεί:
- **Διανυσματικές Αναπαραστάσεις ESM-2**: Μετατροπή πρωτεϊνών σε διανύσματα 320 διαστάσεων
- **5 Μέθοδοι ANN**: Ευκλείδεια LSH, Υπερκύβος, IVF-Flat, IVFPQ, Νευρωνικό LSH
- **Σύγκριση με BLAST**: Αξιολόγηση έναντι παραδοσιακής στοίχισης ακολουθιών
- **Βιολογική Επαλήθευση**: Χρήση σχολιασμών UniProt για επιβεβαίωση

---

## Θεωρητικό Υπόβαθρο

### Τι είναι τα Remote Homologs;

**Ομόλογες πρωτεΐνες** (homologs) είναι πρωτεΐνες που μοιράζονται κοινό εξελικτικό προγονικό. Διακρίνονται σε:

1. **Στενοί ομόλογοι** (close homologs): >40% ταυτότητα αλληλουχίας
   - Εύκολα ανιχνεύσιμοι με BLAST
   - Σαφείς εξελικτικές σχέσεις

2. **Απομακρυσμένοι ομόλογοι** (remote homologs): 15-30% ταυτότητα
   - Διατηρούν παρόμοια **τρισδιάστατη δομή** και **λειτουργία**
   - Χαμηλή ομοιότητα αλληλουχίας λόγω εξελικτικής απόστασης
   - Δύσκολο να ανιχνευθούν με παραδοσιακές μεθόδους

3. **Ζώνη Λυκόφωτος** (Twilight Zone): <30% ταυτότητα
   - Η περιοχή όπου το BLAST αποτυγχάνει
   - Απαιτούνται πιο εξελιγμένες μέθοδοι

### Γιατί τα Embeddings;

**ESM-2** (Evolutionary Scale Modeling) είναι ένα μοντέλο γλώσσας πρωτεϊνών που:
- Εκπαιδεύτηκε σε 65 εκατομμύρια ακολουθίες πρωτεϊνών
- Μαθαίνει **εξελικτικά μοτίβα** και **δομικές σχέσεις**
- Κωδικοποιεί κάθε πρωτεΐνη σε διάνυσμα 320 διαστάσεων
- Οι παρόμοιες πρωτεΐνες έχουν **κοντινά διανύσματα** στον χώρο embedding

**Πλεονέκτημα**: Τα embeddings συλλαμβάνουν **δομική ομοιότητα** ακόμα και όταν η ομοιότητα αλληλουχίας είναι πολύ χαμηλή.

### Αλγόριθμοι ANN

Για την αποδοτική αναζήτηση σε χιλιάδες διανύσματα, χρησιμοποιούμε:

#### 1. Ευκλείδεια LSH (Locality-Sensitive Hashing)
- **Ιδέα**: Κατακερματισμός διανυσμάτων έτσι ώστε τα κοντινά σημεία να πέφτουν στο ίδιο "κουβά"
- **Συναρτήσεις κατακερματισμού**: h(v) = ⌊(a·v + b) / w⌋
  - a: τυχαίο διάνυσμα προβολής
  - b: τυχαία μετατόπιση
  - w: πλάτος κουβά (παράμετρος ευαισθησίας)
- **Πολλαπλοί πίνακες** (L): Αύξηση πιθανότητας εύρεσης γειτόνων

#### 2. Προβολή Υπερκύβου (Hypercube Projection)
- **Ιδέα**: Προβολή σε χαμηλότερες διαστάσεις (π.χ. 320 → 12)
- **Δυαδικός κώδικας**: Κάθε σημείο αντιστοιχεί σε κορυφή υπερκύβου
- **Αναζήτηση**: Εξερεύνηση γειτονικών κορυφών (multi-probe)
- **Συμβιβασμός**: Χάνεται πληροφορία στην προβολή αλλά γίνεται πολύ γρήγορη

#### 3. IVF-Flat (Inverted File with Flat Encoding)
- **Ιδέα**: Διαμέριση του χώρου σε clusters με k-means
- **Ευρετήριο**: Κάθε cluster περιέχει λίστα από διανύσματα
- **Αναζήτηση**: Έλεγχος μόνο των nprobe πλησιέστερων clusters
- **Ακρίβεια**: Πλήρης ακρίβεια εντός των clusters που ελέγχονται

#### 4. IVFPQ (IVF with Product Quantization)
- **Ιδέα**: Συμπίεση διανυσμάτων με κβαντοποίηση προϊόντος
- **Διαμέριση**: Χωρισμός κάθε διανύσματος σε M υπο-διανύσματα
- **Κωδικοποίηση**: Κάθε υπο-διάνυσμα αντικαθίσταται από το πλησιέστερο κέντρο
- **Συμπίεση**: 320 floats → 16 bytes (20x compression)
- **Συμβιβασμός**: Ταχύτητα και μνήμη έναντι ακρίβειας

#### 5. Νευρωνικό LSH (Neural LSH)
- **Ιδέα**: Μάθηση βέλτιστης διαμέρισης με νευρωνικά δίκτυα
- **Διαδικασία**:
  1. Κατασκευή γράφου k-NN (k πλησιέστεροι γείτονες)
  2. Διαμέριση γράφου με KaHIP (balanced graph partitioning)
  3. Εκπαίδευση MLP ταξινομητή για πρόβλεψη διαμερίσματος
  4. Αναζήτηση: Έλεγχος top-T προβλεπόμενων διαμερισμάτων
- **Πλεονέκτημα**: Μαθαίνει την **δομή των δεδομένων**

---

## Αρχεία Έργου

```
projecterg3/
├── protein_embed.py              # Παραγωγή διανυσμάτων ESM-2
├── protein_search.py             # Σύγκριση ANN μεθόδων & BLAST
├── protein_nlsh_build.py         # Κατασκευή ευρετηρίου Neural LSH
├── annotation_helper.py          # Ανάκτηση σχολιασμών UniProt
├── analyze.py                    # Ανάλυση αποτελεσμάτων & οπτικοποίηση
├── dataset_parser.py             # Βοηθητικές συναρτήσεις φόρτωσης
├── distances.py                  # Υπολογισμός αποστάσεων
├── models.py                     # Μοντέλο MLP για Neural LSH
├── graph_utils.py                # Γράφος k-NN & διαμέριση KaHIP
├── nlsh_build.py                 # Εκπαίδευση Neural LSH (από Εργασία 2)
├── nlsh_search.py                # Αναζήτηση Neural LSH (από Εργασία 2)
├── lsh.c / lsh.h                 # Υλοποίηση LSH σε C (από Εργασία 1)
├── hypercube.c / hc.h            # Υλοποίηση Υπερκύβου σε C (από Εργασία 1)
├── ivfflat.c / kmeans.h          # Υλοποίηση IVF-Flat (από Εργασία 1)
├── ivfpq.c / dataload.h          # Υλοποίηση IVFPQ (από Εργασία 1)
├── main.c                        # Κύριο εκτελέσιμο C
├── Makefile                      # Σύστημα μεταγλώττισης
├── requirements.txt              # Εξαρτήσεις Python
├── run_protein_search.sh         # Σενάριο πλήρους εκτέλεσης
├── README.md                     # Αυτό το αρχείο
└── REPORT.md                     # Λεπτομερής πειραματική αναφορά
```

---

## Εγκατάσταση

### Προαπαιτούμενα
- Python 3.10+
- CUDA (προαιρετικό, για επιτάχυνση GPU)
- Μεταγλωττιστής GCC (για modules C)
- Εργαλεία BLAST+

### Εγκατάσταση Εξαρτήσεων Python

```bash
pip install -r requirements.txt
```

ή με conda:

```bash
conda create -n protein_search python=3.10
conda activate protein_search
pip install -r requirements.txt
```

### Εγκατάσταση BLAST

**Ubuntu/Debian:**
```bash
sudo apt-get install ncbi-blast+
```

**macOS:**
```bash
brew install blast
```
---

## Χρήση

### Γρήγορη Εκκίνηση (Πλήρης Διαδικασία)

```bash
# Δώστε δικαιώματα εκτέλεσης στο σενάριο
chmod +x run_protein_search.sh

# Εκτέλεση πλήρους διαδικασίας
./run_protein_search.sh \
    --data swissprot_small_small.fasta \
    --query targets.fasta \
    --output results.txt \
    --method all \
    -N 50
```

Αυτό θα εκτελέσει:
1. Παραγωγή διανυσμάτων ESM-2
2. Κατασκευή ευρετηρίου Neural LSH (αν χρειάζεται)
3. Αναζήτηση ANN με όλες τις μεθόδους
4. Σύγκριση με BLAST

---

### Σενάριο 1: Παραγωγή Διανυσμάτων (Embeddings)

```bash
python protein_embed.py \
    -i swissprot.fasta \
    -o protein_vectors.dat
```

**Παράμετροι:**
- `-i, --input`: Αρχείο εισόδου FASTA με πρωτεΐνες
- `-o, --output`: Αρχείο εξόδου (.fvecs ή .dat)
- `--model`: Μοντέλο ESM-2 (προεπιλογή: facebook/esm2_t6_8M_UR50D)
- `--batch_size`: Μέγεθος δέσμης για GPU (προεπιλογή: 8)

**Έξοδος:**
- `protein_vectors.fvecs`: Διανύσματα σε μορφή fvecs
- `protein_vectors_ids.txt`: Αντιστοίχιση δείκτη → αναγνωριστικό ακολουθίας

---

### Σενάριο 2: Κατασκευή Ευρετηρίου Neural LSH

```bash
python protein_nlsh_build.py \
    -d protein_vectors.fvecs \
    -i ./protein_index \
    --knn 10 \
    -m 100 \
    --epochs 20
```

**Παράμετροι:**
- `-d, --data`: Διανύσματα πρωτεϊνών (.fvecs)
- `-i, --index`: Κατάλογος εξόδου ευρετηρίου
- `--knn`: k για γράφο k-NN (προεπιλογή: 10)
- `-m`: Αριθμός διαμερισμάτων (προεπιλογή: 100)
- `--epochs`: Εποχές εκπαίδευσης (προεπιλογή: 20)

---

### Σενάριο 3: Σύγκριση Μεθόδων ANN

```bash
python protein_search.py \
    -d protein_vectors.dat \
    -q targets.fasta \
    -o results.txt \
    -method all \
    -N 50
```

**Παράμετροι:**
- `-d, --data`: Αρχείο δεδομένων διανυσμάτων (.fvecs)
- `-q, --query`: Αρχείο ερωτημάτων FASTA
- `-o, --output`: Αρχείο εξόδου αποτελεσμάτων
- `-method`: Μέθοδος ANN (`all`, `lsh`, `hypercube`, `neural`, `ivf`, `ivfpq`)
- `-N`: Αριθμός γειτόνων (προεπιλογή: 50)

**Έξοδος:**

Για κάθε ερώτημα, το αρχείο περιέχει:

1. **Συνοπτική σύγκριση**: Ερωτήματα ανά Δευτερόλεπτο (QPS) και Ανάκληση@N για κάθε μέθοδο
2. **Κορυφαίοι-N γείτονες**: Λεπτομερής λίστα με:
   - Αναγνωριστικό γείτονα
   - Απόσταση L2
   - Ταυτότητα BLAST (%)
   - Στους Κορυφαίους-N του BLAST; (Ναι/Όχι)
   - Βιολογικό σχόλιο (π.χ. "Απομακρυσμένος ομόλογος;")

**Παράδειγμα εξόδου:**
```
Πρωτεΐνη Ερωτήματος: sp|Q6GZX4|001R_FRG3G
N = 50 (μέγεθος λίστας Κορυφαίων-N για αξιολόγηση Ανάκλησης@N)

[1] Συνοπτική σύγκριση μεθόδων
------------------------------------------------------------------------------
Μέθοδος              | Χρόνος/ερώτημα (s) | QPS        | Ανάκληση@N vs BLAST Κορυφαίοι-N
------------------------------------------------------------------------------
lsh                  | 0.025              | 40         | 0.88
hypercube            | 0.032              | 31         | 0.84
neural               | 0.012              | 83         | 0.92
ivf                  | 0.010              | 100        | 0.90
ivfpq                | 0.007              | 143        | 0.86
BLAST (Αναφορά)      | 1.450              | 0.7        | 1.00 (ορίζει τους Κορυφαίους-N)
------------------------------------------------------------------------------

[2] Κορυφαίοι-N γείτονες ανά μέθοδο (εδώ π.χ. N = 10 για εκτύπωση)

Μέθοδος: neural
Κατάταξη | Γείτονας ID          | Απόσταση L2 | Ταυτότητα BLAST | Στους BLAST Κορυφαίους-N? | Βιολογικό σχόλιο
--------------------------------------------------------------------------------------------------------------
1        | sp|Q6GZX3|002L       | 0.145       | 18.5            | Ναι                       | Απομακρυσμένος ομόλογος; (Ζώνη Λυκόφωτος)
2        | sp|Q197F8|002R       | 0.167       | 24.2            | Ναι                       | Απομακρυσμένος ομόλογος; (Ζώνη Λυκόφωτος)
...
```



## Προετοιμασία για Εκτελέσιμα C

Πριν εκτελέσετε την αναζήτηση, βεβαιωθείτε ότι έχετε μεταγλωττίσει το εκτελέσιμο `./search`:

```bash
# Στον κεντρικό κατάλογο του έργου
make

# Και χειροκίνητα
cd LSH_Project && make && cd ..
cd HYPERCUBE_Project && make && cd ..
cd IVFFlat && make && cd ..
cd IVFPQ && make && cd ..
```

Το `protein_search.py` αναμένει να βρει το εκτελέσιμο `./search` στον κατάλογο εργασίας.

---

## Βέλτιστες Παράμετροι (από Πειράματα)

Βάσει των πειραματικών αποτελεσμάτων με SwissProt (50χιλ. πρωτεΐνες, διανύσματα 320 διαστάσεων):

### Ευκλείδεια LSH
```
--lsh_k 6          # Συναρτήσεις κατακερματισμού ανά πίνακα
--lsh_L 8          # Αριθμός πινάκων
--lsh_w 1.0        # Πλάτος κουβά
```
**Απόδοση**: Ανάκληση@50 = 0.20-0.66, QPS = 4

### Υπερκύβος
```
--hc_k 12          # Διαστάσεις προβολής
--hc_M 5000        # Μέγιστοι υποψήφιοι
--hc_probes 2      # Κορυφές προς εξερεύνηση
--hc_w 1.5         # Πλάτος κουβά
```
**Απόδοση**: Ανάκληση@50 = 0.10-0.36, QPS = 4

### IVF-Flat
```
--ivf_k 200        # Αριθμός συστάδων (clusters)
--ivf_probe 20     # Συστάδες προς αναζήτηση
```
**Απόδοση**: Ανάκληση@50 = 0.02-0.10, QPS = 0 (αργό λόγω κατασκευής ευρετηρίου)

### IVFPQ
```
--ivf_k 50         # Συστάδες χονδροειδούς κβαντοποιητή
--ivf_probe 5      # Συστάδες προς αναζήτηση
--ivfpq_M 16       # Υπο-χώροι (προεπιλογή)
--ivfpq_nbits 8    # Bits ανά υπο-χώρο (προεπιλογή)
```
**Απόδοση**: Ανάκληση@50 = 0.00-0.18, QPS = 0 (αργό λόγω κατασκευής ευρετηρίου)

### Νευρωνικό LSH
```
-m 15              # Αριθμός διαμερισμάτων
--knn 40           # k για γράφο k-NN
--epochs 70        # Εποχές εκπαίδευσης
--lr 0.00015       # Ρυθμός μάθησης
--neural_T 5       # Παράμετρος πολλαπλής δοκιμής
```
**Απόδοση**: Ανάκληση@50 = 0.00-0.30, QPS = 2

---

## Σημαντικά Ευρήματα

### 1. Απόδοση Μεθόδων
- **Καλύτερη Ανάκληση**: LSH (μέσος όρος 0.28) και Υπερκύβος (μέσος όρος 0.13)
- **Ταχύτερες**: LSH και Υπερκύβος (QPS = 4)
- **Αργότερες**: Μέθοδοι IVF (χρόνος κατασκευής ευρετηρίου)

### 2. Ανίχνευση Απομακρυσμένων Ομολόγων
Από τα αποτελέσματα, παρατηρήσαμε:
- **Πρωτεΐνες Ζώνης Λυκόφωτος**: Πολλές πρωτεΐνες με <30% ταυτότητα BLAST βρέθηκαν κοντά στον χώρο διανυσμάτων
- **Ψευδώς Θετικά**: Υπάρχουν πολλές περιπτώσεις "Πιθανώς ψευδώς θετικό" που χρειάζονται βιολογικό έλεγχο

### 3. Παραδείγματα Απομακρυσμένων Ομολόγων
```
Ερώτημα: A0A009HL96
Μέθοδος: Υπερκύβος
- sp|Q5HI09|GRAR_STAAC: L2=0.18, Ταυτότητα BLAST=1%, Στους BLAST Κορυφαίους-N? Ναι
- sp|A5VUU3|DIVK_BRUO2: L2=0.52, Ταυτότητα BLAST=25%, Ζώνη Λυκόφωτος

Ερώτημα: A0A009HQC9  
Μέθοδος: LSH
- Πολλαπλές πρωτεΐνες RAPA: L2=0.11-0.13, Ταυτότητα BLAST=1-2%, Στους BLAST Κορυφαίους-N? Ναι
```

---

## Βιολογική Αξιολόγηση

### Ορισμός Απομακρυσμένου Ομολόγου

Θεωρούμε μία πρωτεΐνη ως **υποψήφια απομακρυσμένη ομόλογη** όταν:

1. **Ταυτότητα BLAST < 30%** (Ζώνη Λυκόφωτος)
2. **Μικρή απόσταση L2** στον χώρο διανυσμάτων (Κορυφαίοι-N)
3. **Κοινά χαρακτηριστικά**:
   - Ίδιος τομέας Pfam
   - Παρόμοιοι όροι GO
   - Ίδιος αριθμός EC
   - Κοινή λειτουργική οικογένεια

### Χρήση Σχολιασμών UniProt

Για την επαλήθευση απομακρυσμένων ομολόγων:

1. Ανάκτηση καταχωρήσεων UniProt για τους γείτονες
2. Έλεγχος για:
   - Σχολιασμοί λειτουργίας
   - Τομείς Pfam (InterPro)
   - Όροι GO (Μοριακή Λειτουργία, Βιολογική Διαδικασία)
   - Αριθμοί EC (ενζυματική δραστηριότητα)

```python
# Παράδειγμα ελέγχου σχολιασμού
from Bio import Entrez, SwissProt

def check_homology(seq_id1, seq_id2):
    # Ανάκτηση εγγραφών UniProt
    record1 = get_uniprot_record(seq_id1)
    record2 = get_uniprot_record(seq_id2)
    
    # Έλεγχος για κοινούς τομείς
    domains1 = get_pfam_domains(record1)
